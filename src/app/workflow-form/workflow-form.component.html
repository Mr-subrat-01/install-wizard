<form class="wizard-container" [formGroup]="workflowForm">
  @if (step===0) {
  <div class="wizard-step" formGroupName="workflow">
    <h3>Workflow Details</h3>
    <label>Name:</label>
    <input type="text" formControlName="name">
    <label>Description:</label>
    <textarea formControlName="description"></textarea>
    <label>SLA Time(In Hours):</label>
    <input type="number" formControlName="sla">
  </div>
  <div>
    <button (click)="addStage()">+ Add Stage</button>
    <div class="mini-stages-container">
      @for (stage of stages.controls; track $index) {
      <div class="mini-stage">
        <h4>Stage {{ $index + 1 }}</h4>
        <div class="mini-stage-action">
          <button (click)="editOrAddStage($index)">Edit</button>
          <button (click)="removeStage($index)">Delete</button>
        </div>
      </div>
      }
    </div>
  </div>
  }
  @if(step===1){
  <div class="wizard-step" formArrayName="stages">
    <h3>Stages</h3>
    <div [formGroupName]="currentIndex">
      <h4>Stage {{ currentIndex + 1 }}</h4>
      <input type="text" formControlName="name" placeholder="Stage Name">
      <label>Description:</label>
      <textarea formControlName="description"></textarea>
      <div>
        <label class="m-0">Auto Progress:</label>
        <input class="w-auto" type="checkbox" formControlName="auto_progress">
      </div>
      <label>Order Index:</label>
      <input formControlName="order_index" type="number" />
      <label>Condition Expression:</label>
      <input type="text" formControlName="condition_expression">
      <label>SLA Time(In Hours):</label>
      <input type="number" formControlName="sla">
    </div>
    <button (click)="addTask(currentIndex)">+ Add Task</button>
    @if(getTasks(currentIndex).controls.length >0){
    <div class="wizard-step">
      <h3>Tasks({{getTasks(currentIndex).controls.length}})</h3>
      <div [formGroup]="getStageFormGroup(currentIndex)">
        <div formArrayName="tasks">
          <div *ngFor="let task of getTasks(currentIndex).controls; let j = index" [formGroupName]="j">
            <h4>Stage {{ currentIndex + 1 }} Task {{j+1}}</h4>
            <input type="text" formControlName="name" placeholder="Task Name">
            <label>Description:</label>
            <textarea formControlName="description"></textarea>
            <label>Ai Model ID:</label>
            <input type="number" formControlName="ai_model_id" />
            <div>
              <label class="m-0">Auto Execute:</label>
              <input class="w-auto" type="checkbox" formControlName="auto_execute">
            </div>
            <label>Order Index:</label>
            <input formControlName="order_index" type="number" />
            <label>Condition Expression:</label>
            <input type="text" formControlName="condition_expression">
            <label>SLA Time(In Hours):</label>
            <input type="number" formControlName="sla">
            <label>Select Users:</label>
            <ng-select [items]="userList" placeholder="Select Users" bindLabel="name" bindValue="id" [multiple]="true"
              [formControl]="getUserIds(currentIndex, j)">
            </ng-select>

            <p style="color: white;">Selected User IDs: {{ getUserIds(currentIndex, j).value }}</p>
            <div class="wizard-buttons" style="gap: 10px;">
              <button (click)="removeTask(currentIndex, j)">Remove Task ({{j+1}})</button>
              <button (click)="openFormModal()">Create Form</button>
              <button (click)="openRuleDialog()">Create Rule</button>
            </div>

            @if(fields.length > 0){
            <div class="form-container">
              <h3>Form Fields</h3>
              <div class="fields-wrapper">
                <div class="field-box" *ngFor="let key of formJson | keyvalue">
                  <span class="field-name">{{ key.value.label}}</span>
                  <button class="edit-btn" (click)="openFormModal()">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </button>
                </div>
              </div>
            </div>
            }

            @if(rules.length >0){
            <div>
              <h3>Rules</h3>
              <div class="fields-wrapper">
                @for (rule of rules; track $index) {
                <div>
                  {{rule.name}}
                </div>
                }

                <div>
                  <button (click)="addCondition(currentIndex,j)">+ Add Condition</button>
                  @if (getConditions(currentIndex,j).controls.length > 0) {
                  <div class="conditions-wrapper">
                    <div formArrayName="conditions">
                      <div class="condition-row">
                        <label>Column</label>
                        <label>Operator</label>
                        <label>Value</label>
                        <label>Action</label>
                      </div>
                      <div *ngFor="let condition of getConditions(currentIndex,j).controls; let condIndex = index"
                        [formGroupName]="condIndex" class="condition-row">
                        <select formControlName="field" (change)="onFieldChange($event, currentIndex, j, condIndex)">
                          <option value="">Select One</option>
                          <option *ngFor="let field of getObjectKeys(formJson)" [value]="formJson[field].name">{{ formJson[field].label }}</option>
                        </select>

                        <select formControlName="operator">
                          <option value="">Select One</option>
                          <option *ngFor="let op of operators" [value]="op">{{ op }}</option>
                        </select>

                        <input style="width: auto;" [type]="condition.value.inputType" formControlName="value" placeholder="Enter value" />

                        <button class="btn-remove" (click)="removeCondition(currentIndex,j,condIndex)"><i class="fa-solid fa-trash"></i></button>
                      </div>
                    </div>
                  </div>
                  }
                </div>

              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
    }
  </div>
  <div class="wizard-buttons">
    <button (click)="prevStep()">Go Back</button>
    <button>Save</button>
  </div>
  }
</form>
@if (wantToDelete) {
<div class="dialog-overlay">
  <div class="dialog-container">
    <div class="dialog-header">
      <span class="delete-icon">âœ”</span>
      <h2 class="dialog-heading">Delete</h2>
    </div>
    <p>Are you Sure want to delete ?</p>
    <div class="btn-container">
      <button class="no-btn" (click)="closeDeleteDialog()">No</button>
      <button class="yes-btn" (click)="removeCurrentStage()">Yes</button>
    </div>
  </div>
</div>
}
<app-form-builder [isOpen]="isFormModalOpen" (closeModal)="closeFormModal()"
  (formJsonGenerated)="onJsonGenerated($event)">
</app-form-builder>
@if(isRuleDialogOpen){
<div class="dialog-overlay">
  <div class="dialog-container">
    <div class="dialog-header">
      <h2 class="">Add Rule</h2>
    </div>
    <div>
      <input [(ngModel)]="ruleName" style="width: -webkit-fill-available; margin-bottom: 6px; color: white;" type="text"
        placeholder="Enter Rule Name">
      <textarea [(ngModel)]="ruleDescription" style="width: -webkit-fill-available; margin-bottom: 6px; color: white;"
        placeholder="Enter Rule Description" cols="3"></textarea>
    </div>
    <div class="btn-container">
      <button class="no-btn" (click)="closeRuleDialog()">Close</button>
      <button class="yes-btn" (click)="addRule()">Save</button>
    </div>
  </div>
</div>
}
